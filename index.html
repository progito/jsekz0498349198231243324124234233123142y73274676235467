<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Тестирование (40 вопросов)</title>

  <style>
    :root{
      --bg:#0f172a;
      --panel:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#243041;

      --primary:#2563eb;
      --danger:#dc2626;
      --ok:#16a34a;

      --radius: 12px;
      --maxw: 980px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --focus: 0 0 0 3px rgba(37,99,235,.35);
    }

    [data-theme="light"]{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#2563eb;
      --danger:#dc2626;
      --ok:#16a34a;
      --focus: 0 0 0 3px rgba(37,99,235,.25);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:var(--font);color:var(--text);background:var(--bg);}

    .container{max-width:var(--maxw);margin:0 auto;padding:12px 12px 40px;}
    header{position:sticky;top:0;z-index:20;background:var(--bg);border-bottom:1px solid var(--border);}
    .headerRow{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0;}
    .brand{display:flex;align-items:center;gap:10px;min-width:200px;}
    .logo{width:36px;height:36px;border-radius:10px;background:var(--primary);display:grid;place-items:center;flex:0 0 auto;}
    .logo svg{width:20px;height:20px;fill:#fff}
    .brand h1{font-size:14px;margin:0;font-weight:800;line-height:1.2;}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px;display:block;line-height:1.35;}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}

    .stack{display:flex;flex-direction:column;gap:12px;}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:12px;}
    .card h2{margin:0 0 8px;font-size:14px;font-weight:800;}
    .muted{color:var(--muted)}
    .divider{height:1px;background:var(--border);margin:12px 0;}

    .btn{
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      border-radius:10px;
      padding:10px 12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      font-weight:700;
      line-height:1;
      min-height:40px;
    }
    .btn:hover{border-color: color-mix(in oklab, var(--border), #fff 12%)}
    .btn:active{transform: translateY(1px)}
    .btn:focus{outline:none; box-shadow: var(--focus)}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff;}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff;}

    .icon{width:16px;height:16px;display:inline-block;flex:0 0 auto;fill:currentColor;}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      width:100%;
      justify-content:space-between;
    }
    .pill strong{font-weight:800}
    .timer{font-family:var(--mono);font-weight:800;letter-spacing:.2px;}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
    .row.center{align-items:center}
    .row.between{justify-content:space-between}

    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px;}
    .field{flex:1;min-width:220px;}

    input[type="text"], select{
      width:100%;
      padding:11px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      font-family:var(--font);
      outline:none;
    }
    select{cursor:pointer}
    input:focus, select:focus{box-shadow:var(--focus)}
    .help{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.4;}

    .q{border:1px solid var(--border);border-radius:var(--radius);padding:12px;background:transparent;}
    .qhead{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;margin-bottom:10px;}
    .qtitle{font-weight:800;font-size:14px;line-height:1.25;margin:0;}
    .qmeta{font-size:12px;color:var(--muted);margin-top:6px;}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      color:var(--text);font-size:12px;white-space:nowrap;font-weight:700;background:transparent;
    }

    .opt{
      display:flex;gap:10px;align-items:flex-start;
      padding:10px;border-radius:10px;border:1px solid var(--border);background:transparent;
    }
    .opt input{margin-top:3px}
    .opt .ot{font-size:13px;line-height:1.35}

    .hidden{display:none !important}
    .right{margin-left:auto}
    .mono{font-family:var(--mono)}
    .small{font-size:12px}

    .stickybar{ position: sticky; top: 58px; z-index: 10; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      z-index: 9999;
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 10px 12px;
      border-radius: 12px;
      max-width: 760px;
      width: calc(100% - 20px);
    }
    .toast .trow{display:flex; gap:10px; align-items:flex-start}
    .toast .tmsg{font-size: 13px; line-height: 1.35}
    .toast .tbtn{margin-left:auto; flex:0 0 auto}

    @media (max-width: 720px){
      .brand .sub{ display:none; }
      .stickybar{ position: static; top:auto; }
      .btn{ width: 100%; }
      .field{ min-width: 100%; }
    }
  </style>
</head>

<body>
  <div class="container" id="app">
    <header>
      <div class="headerRow">
        <div class="brand">
          <div class="logo" aria-hidden="true" title="Тестирование">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 3 1 9l11 6 9-4.91V17h2V9L12 3zm0 14.2L4.24 13 12 16.8 19.76 13 12 17.2z"/>
            </svg>
          </div>
          <div>
            <h1>Веб‑тестирование</h1>
            <span class="sub">Только тест: 40 вопросов · 1:50:00 · импорт/экспорт JSON</span>
          </div>
        </div>

        <div class="top-actions">
          <button class="btn" id="btnSettings" title="Настройки">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M19.14,12.94a7.43,7.43,0,0,0,.05-.94,7.43,7.43,0,0,0-.05-.94l2.11-1.65a.5.5,0,0,0,.12-.63l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.28,7.28,0,0,0-1.63-.94l-.38-2.65A.5.5,0,0,0,13.8,2H10.2a.5.5,0,0,0-.49.42L9.33,5.07a7.28,7.28,0,0,0-1.63.94l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.63L4.86,11.06a7.43,7.43,0,0,0,0,1.88L2.75,14.59a.5.5,0,0,0-.12.63l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.28,7.28,0,0,0,1.63.94l.38,2.65a.5.5,0,0,0,.49.42h3.6a.5.5,0,0,0,.49-.42l.38-2.65a7.28,7.28,0,0,0,1.63-.94l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.63ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
            Настройки
          </button>
        </div>
      </div>
    </header>

    <section class="stack">
      <div class="card">
        <h2>Данные</h2>

        <div class="row center">
          <div class="pill" title="Статус данных">
            <span class="muted">data.json</span>
            <strong id="dataStatus">проверка…</strong>
          </div>

          <button class="btn" id="btnLoadData">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M5 20h14v-2H5v2zM12 2l-5.5 5.5 1.42 1.42L11 5.84V16h2V5.84l3.08 3.08 1.42-1.42L12 2z"/></svg>
            Перезагрузить
          </button>

          <button class="btn" id="btnPickDataFile" title="Если fetch недоступен (file://), выберите файл вручную">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M10 16l5-4-5-4v8zm-7-6c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2v8c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2v-8zm2 0v8h14v-8H5z"/></svg>
            Выбрать файл…
          </button>
          <input id="dataFileInput" type="file" accept="application/json" class="hidden" />
        </div>

        <div class="help">
          Если открываете <span class="mono">index.html</span> через <span class="mono">file://</span>, браузер может блокировать
          загрузку <span class="mono">./data.json</span>. Тогда используйте «Выбрать файл…».
        </div>
      </div>

      <div class="card">
        <h2>Тест</h2>

        <div class="row">
          <div class="field">
            <label for="studentName">ФИО / Имя</label>
            <input id="studentName" type="text" placeholder="Например: Иванов Иван" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="testSelect">Выбор теста</label>
            <select id="testSelect">
              <option value="" selected disabled>Выберите тест…</option>
            </select>
            <div class="help">Берутся только вопросы: ровно <b>40</b> (или меньше, если в банке меньше). Варианты ответов перемешиваются.</div>
          </div>

          <div class="field">
            <label>Общее время</label>
            <div class="pill">
              <span class="muted">Таймер</span>
              <span class="timer" id="studentTimer">01:50:00</span>
            </div>
            <div class="help">По истечении времени — авто‑завершение и формирование JSON.</div>
          </div>
        </div>

        <div class="row center" style="margin-top:10px">
          <button class="btn primary" id="btnStartTest">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
            Начать
          </button>

          <button class="btn danger hidden" id="btnFinishTest">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6h12v12H6z"/></svg>
            Завершить
          </button>

          <button class="btn hidden" id="btnExportStudentJson">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm1 7V3.5L18.5 9H15zM8 13h8v2H8v-2zm0 4h8v2H8v-2z"/></svg>
            Скачать JSON
          </button>

          <span class="right muted small" id="studentProgressText"></span>
        </div>
      </div>

      <div id="studentTestArea" class="hidden stack">
        <div class="stickybar">
          <div class="card" style="padding:12px">
            <div class="row center">
              <div class="pill" style="max-width:360px">
                <span class="muted">Осталось</span>
                <strong class="timer" id="studentTimerSticky">01:50:00</strong>
              </div>

              <div class="pill">
                <span class="muted">Тест</span>
                <strong id="activeTestName">—</strong>
              </div>

              <button class="btn danger right" id="btnFinishTestTop">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6h12v12H6z"/></svg>
                Завершить
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 id="theoryTitle">Теория (40 вопросов)</h2>
          <div id="theoryList" class="stack"></div>
        </div>

        <div class="card">
          <h2>Статус</h2>
          <div id="studentStatus" class="muted small">Ожидание запуска теста…</div>
        </div>
      </div>
    </section>

    <!-- SETTINGS MODAL -->
    <section id="settingsModal" class="hidden" aria-modal="true" role="dialog">
      <div class="modalOverlay" id="settingsOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:9000;display:flex;align-items:flex-start;justify-content:center;padding:16px 10px;">
        <div class="card" style="width:min(var(--maxw), 100%);">
          <div class="row between center">
            <div>
              <div style="font-weight:900; margin-bottom:6px">Настройки</div>
              <div class="muted small">Тема сохраняется в браузере.</div>
            </div>
            <button class="btn" id="btnCloseSettings">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
              Закрыть
            </button>
          </div>

          <div class="divider"></div>

          <div class="row between center">
            <div>
              <div style="font-weight:800">Тема</div>
              <div class="muted small">Светлая / Тёмная</div>
            </div>
            <div style="display:flex;gap:8px;padding:4px;border:1px solid var(--border);border-radius:12px;">
              <button id="themeDark2" class="btn" type="button" style="min-width:110px">Тёмная</button>
              <button id="themeLight2" class="btn" type="button" style="min-width:110px">Светлая</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="muted small" style="line-height:1.55">
            <div><b>Тест:</b> ровно <b>40</b> вопросов (если в банке меньше — берём сколько есть).</div>
            <div><b>Ответы:</b> варианты перемешиваются.</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast hidden" role="status" aria-live="polite">
    <div class="trow">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
      <div class="tmsg" id="toastMsg">—</div>
      <button class="btn tbtn" id="toastClose" aria-label="Закрыть">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </button>
    </div>
  </div>

  <script>
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];

    function uid(prefix="id"){
      return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
    function nowIso(){ return new Date().toISOString(); }

    function pad2(n){ return String(n).padStart(2,"0"); }
    function formatHMS(totalSec){
      const h = Math.floor(totalSec/3600);
      const m = Math.floor((totalSec%3600)/60);
      const s = totalSec%60;
      return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
    }

    function downloadJson(filename, obj){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    }

    function toast(msg, ms=4200){
      const el = $("#toast");
      $("#toastMsg").textContent = msg;
      el.classList.remove("hidden");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.classList.add("hidden"), ms);
    }
    $("#toastClose").addEventListener("click", ()=> $("#toast").classList.add("hidden"));

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function cssEscape(str){
      return String(str).replaceAll('"','\\"').replaceAll("\\","\\\\");
    }

    function shuffleInPlace(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    function sampleN(arr, n){
      const copy = arr.slice();
      shuffleInPlace(copy);
      return copy.slice(0, Math.min(n, copy.length));
    }

    // Theme
    function setTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
      const isDark = theme === "dark";
      $("#themeDark2").classList.toggle("primary", isDark);
      $("#themeLight2").classList.toggle("primary", !isDark);
    }

    // Data
    let DATA = null;

    async function loadDataJsonByFetch(){
      const resp = await fetch("./data.json", {cache:"no-store"});
      if(!resp.ok) throw new Error("Не удалось загрузить data.json (fetch).");
      const json = await resp.json();
      validateData(json);
      return json;
    }

    async function loadDataJsonFromFile(file){
      const text = await file.text();
      const json = JSON.parse(text);
      validateData(json);
      return json;
    }

    function normalizeTheory(theoryRaw, testId){
      if(Array.isArray(theoryRaw)) return theoryRaw;
      if(theoryRaw && typeof theoryRaw === "object"){
        const out = [];
        for(const [k, v] of Object.entries(theoryRaw)){
          if(!Array.isArray(v)){
            throw new Error(`data.json: theory.${k} должен быть массивом (test=${testId})`);
          }
          out.push(...v);
        }
        return out;
      }
      return [];
    }

    function validateData(json){
      if(!json || typeof json !== "object") throw new Error("data.json: неверный JSON");
      if(!Array.isArray(json.tests)) throw new Error("data.json: ожидается поле tests (array)");

      for(const t of json.tests){
        if(!t || typeof t !== "object") throw new Error("data.json: элемент tests должен быть объектом");
        if(!t.id || !t.title) throw new Error("data.json: у теста должны быть id и title");

        t.theory = normalizeTheory(t.theory, t.id);

        for(let i=0; i<t.theory.length; i++){
          const q = t.theory[i];
          if(!q || typeof q !== "object"){
            throw new Error(`data.json: theory[${i}] не объект (test=${t.id})`);
          }
          if(!q.id || !q.type || !q.question){
            throw new Error(`data.json: theory должен иметь id/type/question (test=${t.id}, index=${i})`);
          }
          if(!["single","multi"].includes(q.type)){
            throw new Error(`data.json: theory.type single|multi (question=${q.id})`);
          }
          if(!Array.isArray(q.options) || q.options.length < 2){
            throw new Error(`data.json: options >=2 (question=${q.id})`);
          }
          if(!Array.isArray(q.correct) || q.correct.length < 1){
            throw new Error(`data.json: correct >=1 (question=${q.id})`);
          }
          for(const o of q.options){
            if(!o || typeof o !== "object" || !o.id || o.text == null){
              throw new Error(`data.json: option должен иметь id/text (question=${q.id})`);
            }
          }
        }
      }
    }

    function updateDataStatus(){
      $("#dataStatus").textContent = DATA ? "загружен" : "не загружен";
    }

    function populateTestsSelect(){
      const sel = $("#testSelect");
      sel.innerHTML = `<option value="" selected disabled>Выберите тест…</option>`;
      if(!DATA) return;
      for(const t of DATA.tests){
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.title;
        sel.appendChild(opt);
      }
    }

    function getTestById(testId){
      if(!DATA) return null;
      return DATA.tests.find(t => t.id === testId) || null;
    }

    async function ensureDataLoadedSilently(){
      try{
        DATA = await loadDataJsonByFetch();
        updateDataStatus();
        populateTestsSelect();
        return true;
      }catch{
        DATA = null;
        updateDataStatus();
        populateTestsSelect();
        return false;
      }
    }

    // Rules (без задач и без режима преподавателя)
    const TEST_TOTAL_SECONDS = 6600; // 1h 50m
    const THEORY_COUNT = 40;

    const STUDENT = { active:false, startedAt:null, endsAt:null, timerInt:null, attempt:null, test:null };

    function setStudentTimerDisplay(remainingSec){
      const text = formatHMS(Math.max(0, remainingSec));
      $("#studentTimer").textContent = text;
      $("#studentTimerSticky").textContent = text;
    }

    function startStudentTimer(){
      clearInterval(STUDENT.timerInt);
      STUDENT.timerInt = setInterval(()=>{
        const rem = Math.round((STUDENT.endsAt - Date.now())/1000);
        setStudentTimerDisplay(rem);
        if(rem <= 0){
          clearInterval(STUDENT.timerInt);
          toast("Время истекло. Тест завершён автоматически.");
          finishTest(true);
        }
      }, 300);
    }

    function resetUI(){
      $("#btnFinishTest").classList.add("hidden");
      $("#btnFinishTestTop").classList.add("hidden");
      $("#btnExportStudentJson").classList.add("hidden");
      $("#btnStartTest").classList.remove("hidden");

      $("#studentProgressText").textContent = "";
      $("#studentStatus").textContent = "Ожидание запуска теста…";

      $("#studentTestArea").classList.add("hidden");
      $("#theoryList").innerHTML = "";
      $("#activeTestName").textContent = "—";

      setStudentTimerDisplay(TEST_TOTAL_SECONDS);
    }

    function updateStudentProgress(){
      if(!STUDENT.attempt) return;
      const th = STUDENT.attempt.sections.theory;
      const answeredTheory = th.filter(q => (q.answer||[]).length>0).length;
      $("#studentProgressText").textContent = `Ответы: ${answeredTheory}/${th.length}`;
    }

    function buildAttempt(test, studentName){
      const pickedTheoryRaw = sampleN(test.theory, THEORY_COUNT);

      const pickedTheory = pickedTheoryRaw.map(q => {
        const opts = shuffleInPlace(q.options.slice()).map(o => ({id:o.id, text:o.text}));
        return {
          id: q.id,
          type: q.type,
          question: q.question,
          options: opts,
          correct: q.correct,
          answer: [],
          autoPoints: 0,
          maxPoints: 1
        };
      });

      return {
        schema: "studentAttempt.v7_theoryOnly",
        attemptId: uid("attempt"),
        createdAt: nowIso(),
        student: { name: studentName || "" },
        test: { id: test.id, title: test.title },
        timing: { startedAt: nowIso(), durationSeconds: TEST_TOTAL_SECONDS, endedAt: null, autoFinished: false },
        sections: { theory: pickedTheory },
        totals: {
          theoryAuto: { points: 0, max: pickedTheory.length },
          total: { points: 0, max: pickedTheory.length, percent: 0 }
        }
      };
    }

    function renderTheoryQuestion(q, idx){
      const wrap = document.createElement("div");
      wrap.className = "q";
      wrap.dataset.qid = q.id;

      const head = document.createElement("div");
      head.className = "qhead";

      const title = document.createElement("div");
      title.innerHTML = `
        <div class="qtitle">${idx+1}. ${escapeHtml(q.question)}</div>
        <div class="qmeta">Тип: <span class="mono">${q.type === "single" ? "один ответ" : "несколько ответов"}</span></div>
      `;

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = "Теория";

      head.appendChild(title);
      head.appendChild(badge);

      const opts = document.createElement("div");
      opts.className = "stack";
      opts.style.gap = "8px";

      for(const opt of q.options){
        const id = uid("opt");
        const line = document.createElement("label");
        line.className = "opt";
        line.setAttribute("for", id);

        const input = document.createElement("input");
        input.id = id;
        input.type = (q.type === "single") ? "radio" : "checkbox";
        input.name = "q_" + q.id;
        input.value = opt.id;

        input.addEventListener("change", ()=>{
          const selected = $$( `input[name="q_${cssEscape(q.id)}"]:checked`, wrap).map(x=>x.value);
          const target = STUDENT.attempt.sections.theory.find(x=>x.id===q.id);
          target.answer = selected;
          updateStudentProgress();
        });

        const txt = document.createElement("div");
        txt.className = "ot";
        txt.textContent = opt.text;

        line.appendChild(input);
        line.appendChild(txt);
        opts.appendChild(line);
      }

      wrap.appendChild(head);
      wrap.appendChild(opts);
      return wrap;
    }

    function autoGradeTheory(attempt){
      let pts = 0;
      for(const q of attempt.sections.theory){
        const a = (q.answer || []).slice().sort();
        const c = (q.correct || []).slice().sort();
        const ok = a.length === c.length && a.every((v,i)=>v===c[i]);
        q.autoPoints = ok ? 1 : 0;
        pts += q.autoPoints;
      }
      attempt.totals.theoryAuto.points = pts;
      attempt.totals.theoryAuto.max = attempt.sections.theory.length;

      attempt.totals.total.points = pts;
      attempt.totals.total.max = attempt.sections.theory.length;
      attempt.totals.total.percent = attempt.totals.total.max > 0
        ? Math.round((attempt.totals.total.points/attempt.totals.total.max)*100)
        : 0;
    }

    function finishTest(auto=false){
      if(!STUDENT.active || !STUDENT.attempt) return;

      STUDENT.active = false;
      clearInterval(STUDENT.timerInt);

      STUDENT.attempt.timing.endedAt = nowIso();
      STUDENT.attempt.timing.autoFinished = !!auto;

      autoGradeTheory(STUDENT.attempt);

      const thPts = STUDENT.attempt.totals.theoryAuto.points;
      const thMax = STUDENT.attempt.totals.theoryAuto.max;
      const thPercent = STUDENT.attempt.totals.total.percent;

      $("#studentStatus").innerHTML =
        `Тест завершён. Результат: <b>${thPts}/${thMax}</b> (${thPercent}%).`;

      $("#btnExportStudentJson").classList.remove("hidden");
      $("#btnFinishTest").classList.add("hidden");
      $("#btnFinishTestTop").classList.add("hidden");
      $("#btnStartTest").classList.remove("hidden");

      $$("#studentTestArea input").forEach(el => el.disabled = true);
      toast("Можно скачать JSON результата.");
    }

    function confirmFinish(){
      if(!STUDENT.active) return;
      const ok = confirm("Завершить тест сейчас? Теория будет проверена автоматически, сформируется JSON.");
      if(ok) finishTest(false);
    }

    // Events
    $("#btnSettings").addEventListener("click", ()=> $("#settingsModal").classList.remove("hidden"));
    $("#btnCloseSettings").addEventListener("click", ()=> $("#settingsModal").classList.add("hidden"));
    $("#settingsOverlay").addEventListener("click", (e)=>{
      if(e.target === e.currentTarget) $("#settingsModal").classList.add("hidden");
    });

    $("#themeDark2").addEventListener("click", ()=> setTheme("dark"));
    $("#themeLight2").addEventListener("click", ()=> setTheme("light"));

    $("#btnLoadData").addEventListener("click", async ()=>{
      try{
        DATA = await loadDataJsonByFetch();
        updateDataStatus();
        populateTestsSelect();
        toast("data.json загружен (fetch).");
      }catch(err){
        DATA = null;
        updateDataStatus();
        populateTestsSelect();
        toast(err?.message || "Ошибка загрузки data.json");
      }
    });

    $("#btnPickDataFile").addEventListener("click", ()=> $("#dataFileInput").click());
    $("#dataFileInput").addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        DATA = await loadDataJsonFromFile(file);
        updateDataStatus();
        populateTestsSelect();
        toast("data.json загружен из файла.");
      }catch(err){
        toast(err.message || "Ошибка чтения data.json");
      }finally{
        e.target.value = "";
      }
    });

    $("#btnStartTest").addEventListener("click", ()=>{
      if(!DATA){
        toast("Сначала загрузите data.json.");
        return;
      }
      const studentName = $("#studentName").value.trim();
      const testId = $("#testSelect").value;

      if(!testId){ toast("Выберите тест."); return; }
      if(!studentName){ toast("Введите имя (ФИО)."); return; }

      const test = getTestById(testId);
      if(!test){ toast("Тест не найден в data.json."); return; }

      const bankTheoryCount = test.theory?.length || 0;
      if(bankTheoryCount < 2){
        toast("В банке теории должно быть минимум 2 вопроса.");
        return;
      }
      if(bankTheoryCount < THEORY_COUNT){
        toast(`Внимание: в банке теории меньше ${THEORY_COUNT}. Будет взято ${Math.min(THEORY_COUNT, bankTheoryCount)}.`);
      }

      STUDENT.active = true;
      STUDENT.test = test;
      STUDENT.startedAt = Date.now();
      STUDENT.endsAt = STUDENT.startedAt + TEST_TOTAL_SECONDS*1000;
      STUDENT.attempt = buildAttempt(test, studentName);

      $("#activeTestName").textContent = test.title;
      $("#studentStatus").textContent = "Тест запущен. Заполните ответы и нажмите «Завершить».";
      $("#studentTestArea").classList.remove("hidden");
      $("#btnFinishTest").classList.remove("hidden");
      $("#btnFinishTestTop").classList.remove("hidden");
      $("#btnExportStudentJson").classList.add("hidden");
      $("#btnStartTest").classList.add("hidden");

      $("#theoryTitle").textContent = `Теория (${STUDENT.attempt.sections.theory.length} вопросов)`;
      $("#theoryList").innerHTML = "";

      STUDENT.attempt.sections.theory.forEach((q, idx)=> $("#theoryList").appendChild(renderTheoryQuestion(q, idx)));

      $$("#studentTestArea input").forEach(el => el.disabled = false);

      updateStudentProgress();
      setStudentTimerDisplay(TEST_TOTAL_SECONDS);
      startStudentTimer();
      window.scrollTo({top:0, behavior:"instant"});
    });

    $("#btnFinishTest").addEventListener("click", confirmFinish);
    $("#btnFinishTestTop").addEventListener("click", confirmFinish);

    $("#btnExportStudentJson").addEventListener("click", ()=>{
      if(!STUDENT.attempt){ toast("Нет данных для экспорта."); return; }
      autoGradeTheory(STUDENT.attempt);
      const st = STUDENT.attempt.student?.name ? STUDENT.attempt.student.name.replaceAll(" ","_") : "student";
      const test = STUDENT.attempt.test?.id || "test";
      downloadJson(`attempt_${test}_${st}.json`, STUDENT.attempt);
    });

    // Init
    (async function init(){
      const saved = localStorage.getItem("theme");
      setTheme(saved === "light" ? "light" : "dark");

      updateDataStatus();
      populateTestsSelect();
      resetUI();

      await ensureDataLoadedSilently();
    })();
  </script>
</body>
</html>
